from http.server import BaseHTTPRequestHandler
import json
import base64
import os
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import tensorflow as tf
from collections import Counter
import itertools
import matplotlib
from sklearn.preprocessing import StandardScaler
from tensorflow.keras.models import load_model
from joblib import load
from io import BytesIO

class handler(BaseHTTPRequestHandler):
    def do_POST(self):
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)

        # Assuming post_data is JSON
        data = json.loads(post_data.decode('utf-8'))
        # Process data here to generate audiogram

        # Placeholder image URL
        #image_url = "https://placekitten.com/200/300"

        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        response = json.dumps({'audiogramImageUrl': image_url})
        self.wfile.write(response.encode())

        matplotlib.rcParams['font.family'] = 'Times New Roman'
        matplotlib.rcParams['font.size'] = 16
        
        df = pd.read_csv('../data/output-csv.csv')
        industryMapping = {'Abrasive Product Manufacturing': 1, 'Adhesive Manufacturing': 2, 'Administration of Air and Water Resource and Solid Waste Management Programs': 3, 'Administration of Conservation Programs': 4, 'Administration of Education Programs': 5, 'Administration of General Economic Programs': 6, "Administration of Human Resource Programs (except Education, Public Health, and Veterans' Affairs Programs)": 7, 'Administration of Public Health Programs': 8, 'Administration of Urban Planning and Community and Rural Development': 9, 'Administrative Management and General Management Consulting Services': 10, 'Air Purification Equipment Manufacturing': 11, 'Air-Conditioning and Warm Air Heating Equipment and Commercial and Industrial Refrigeration Equipment Manufacturing': 12, 'Aircraft Engine and Engine Parts Manufacturing': 13, 'Aircraft Manufacturing': 14, 'Airport Operations': 15, 'Alkalies and Chlorine Manufacturing': 16, 'All Other Amusement and Recreation Industries': 17, 'All Other Automotive Repair and Maintenance': 18, 'All Other Basic Inorganic Chemical Manufacturing': 19, 'All Other Basic Organic Chemical Manufacturing': 20, 'All Other Business Support Services': 21, 'All Other Converted Paper Product Manufacturing': 22, 'All Other Cut and Sew Apparel Manufacturing': 23, 'All Other General Merchandise Stores': 24, 'All Other General Purpose Machinery Manufacturing': 25, 'All Other Health and Personal Care Stores': 26, 'All Other Industrial Machinery Manufacturing': 27, 'All Other Miscellaneous Ambulatory Health Care Services': 28, 'All Other Miscellaneous Chemical Product and Preparation Manufacturing': 29, 'All Other Miscellaneous Crop Farming': 30, 'All Other Miscellaneous Electrical Equipment and Component Manufacturing': 31, 'All Other Miscellaneous Fabricated Metal Product Manufacturing': 32, 'All Other Miscellaneous Food Manufacturing': 33, 'All Other Miscellaneous General Purpose Machinery Manufacturing': 34, 'All Other Miscellaneous Manufacturing': 35, 'All Other Miscellaneous Nonmetallic Mineral Product Manufacturing': 36, 'All Other Miscellaneous Schools and Instruction': 37, 'All Other Miscellaneous Store Retailers (except Tobacco Stores)': 38, 'All Other Miscellaneous Textile Product Mills': 39, 'All Other Miscellaneous Wood Product Manufacturing': 40, 'All Other Motor Vehicle Parts Manufacturing': 41, 'All Other Nonmetallic Mineral Mining': 42, 'All Other Petroleum and Coal Products Manufacturing': 43, 'All Other Pipeline Transportation': 44, 'All Other Plastics Product Manufacturing': 45, 'All Other Professional, Scientific, and Technical Services': 46, 'All Other Publishers': 47, 'All Other Rubber Product Manufacturing': 48, 'All Other Specialty Food Stores': 49, 'All Other Specialty Trade Contractors': 50, 'All Other Support Activities for Transportation': 51, 'All Other Support Services': 52, 'All Other Telecommunications': 53, 'All Other Transit and Ground Passenger Transportation': 54, 'All Other Transportation Equipment Manufacturing': 55, 'Aluminum Die-Casting Foundries': 56, 'Aluminum Extruded Product Manufacturing': 57, 'Aluminum Foundries (except Die-Casting)': 58, 'Aluminum Sheet, Plate, and Foil Manufacturing': 59, 'Ambulance Services': 60, 'Ammunition (except Small Arms) Manufacturing': 61, 'Analytical Laboratory Instrument Manufacturing': 62, 'Animal (except Poultry) Slaughtering': 63, 'Animal Food Manufacturing': 64, 'Animal Slaughtering and Processing': 65, 'Appliance Repair and Maintenance': 66, 'Architectural Services': 67, 'Asphalt Paving Mixture and Block Manufacturing': 68, 'Asphalt Shingle and Coating Materials Manufacturing': 69, 'Audio and Video Equipment Manufacturing': 70, 'Automatic Environmental Control Manufacturing for Residential, Commercial, and Appliance Use': 71, 'Automatic Vending Machine Manufacturing': 72, 'Automobile Manufacturing': 73, 'Automobile and Other Motor Vehicle Merchant Wholesalers': 74, 'Automotive Body, Paint, and Interior Repair and Maintenance': 75, 'Automotive Exhaust System Repair': 76, 'Automotive Parts and Accessories Stores': 77, 'Ball and Roller Bearing Manufacturing': 78, 'Bare Printed Circuit Board Manufacturing': 79, 'Beauty Salons': 80, 'Beet Sugar Manufacturing': 81, 'Beverage and Tobacco Product Manufacturing': 82, 'Bituminous Coal and Lignite Surface Mining': 83, 'Blankbook, Looseleaf Binders, and Devices Manufacturing': 84, 'Blind and Shade Manufacturing': 85, 'Blood and Organ Banks': 86, 'Boat Building': 87, 'Boat Dealers': 88, 'Bolt, Nut, Screw, Rivet, and Washer Manufacturing': 89, 'Book Publishers': 90, 'Books Printing': 91, 'Bottled Water Manufacturing': 92, 'Breakfast Cereal Manufacturing': 93, 'Breweries': 94, 'Brick and Structural Clay Tile Manufacturing': 95, 'Brick, Stone, and Related Construction Material Merchant Wholesalers': 96, 'Broadwoven Fabric Mills': 97, 'Broom, Brush, and Mop Manufacturing': 98, 'Building Inspection Services': 99, 'Burial Casket Manufacturing': 100, 'Bus and Other Motor Vehicle Transit Systems': 101, 'Business Associations': 102, 'Cable and Other Subscription Programming': 103, 'Cane Sugar Refining': 104, 'Car Washes': 105, 'Carbon and Graphite Product Manufacturing': 106, 'Carburetor, Piston, Piston Ring, and Valve Manufacturing': 107, 'Carpet and Rug Mills': 108, 'Carpet and Upholstery Cleaning Services': 109, 'Caterers': 110, 'Cement Manufacturing': 111, 'Ceramic Wall and Floor Tile Manufacturing': 112, 'Cheese Manufacturing': 113, 'Chicken Egg Production': 114, 'Child Day Care Services': 115, 'Chocolate and Confectionery Manufacturing from Cacao Beans': 116, 'Civic and Social Organizations': 117, 'Clothing Accessories Stores': 118, 'Coal and Other Mineral and Ore Merchant Wholesalers': 119, 'Coastal and Great Lakes Freight Transportation': 120, 'Coated Paper Bag and Pouch Manufacturing': 121, 'Coated and Laminated Packaging Paper Manufacturing': 122, 'Coated and Laminated Paper Manufacturing': 123, 'Coffee and Tea Manufacturing': 124, 'Coin-Operated Laundries and Drycleaners': 125, 'Colleges, Universities, and Professional Schools': 126, 'Commercial Bakeries': 127, 'Commercial Flexographic Printing': 128, 'Commercial Gravure Printing': 129, 'Commercial Lithographic Printing': 130, 'Commercial Screen Printing': 131, 'Commercial and Industrial Machinery and Equipment (except Automotive and Electronic) Repair and Maintenance': 132, 'Commercial and Institutional Building Construction': 133, 'Commercial, Industrial, and Institutional Electric Lighting Fixture Manufacturing': 134, 'Commodity Contracts Dealing': 135, 'Computer Facilities Management Services': 136, 'Computer Systems Design Services': 137, 'Computer and Computer Peripheral Equipment and Software Merchant Wholesalers': 138, 'Computer and Software Stores': 139, 'Concrete Block and Brick Manufacturing': 140, 'Concrete Pipe Manufacturing': 141, 'Confectionery Manufacturing from Purchased Chocolate': 142, 'Confectionery Merchant Wholesalers': 143, 'Construction': 144, 'Construction Machinery Manufacturing': 145, 'Construction Sand and Gravel Mining': 146, 'Construction and Mining (except Oil Well) Machinery and Equipment Merchant Wholesalers': 147, 'Construction, Mining, and Forestry Machinery and Equipment Rental and Leasing': 148, 'Convenience Stores': 149, 'Conveyor and Conveying Equipment Manufacturing': 150, 'Copper Foundries (except Die-Casting)': 151, 'Copper Rolling, Drawing, and Extruding': 152, 'Copper Wire (except Mechanical) Drawing': 153, 'Correctional Institutions': 154, 'Corrugated and Solid Fiber Box Manufacturing': 155, 'Couriers and Express Delivery Services': 156, 'Courts': 157, 'Creamery Butter Manufacturing': 158, 'Credit Bureaus': 159, 'Credit Unions': 160, 'Crushed and Broken Granite Mining and Quarrying': 161, 'Crushed and Broken Limestone Mining and Quarrying': 162, 'Current-Carrying Wiring Device Manufacturing': 163, 'Custom Architectural Woodwork and Millwork Manufacturing': 164, 'Custom Compounding of Purchased Resins': 165, 'Custom Computer Programming Services': 166, 'Cut Stock, Resawing Lumber, and Planing': 167, 'Cut Stone and Stone Product Manufacturing': 168, 'Cutlery and Flatware (except Precious) Manufacturing': 169, 'Cutting Tool and Machine Tool Accessory Manufacturing': 170, 'Cyclic Crude and Intermediate Manufacturing': 171, 'Dairy Cattle and Milk Production': 172, 'Dairy Product (except Dried or Canned) Merchant Wholesalers': 173, 'Deep Sea Freight Transportation': 174, 'Die-Cut Paper and Paperboard Office Supplies Manufacturing': 175, 'Digital Printing': 176, 'Dimension Stone Mining and Quarrying': 177, 'Direct Health and Medical Insurance Carriers': 178, 'Direct Mail Advertising': 179, 'Direct Title Insurance Carriers': 180, 'Distilleries': 181, 'Document Preparation Services': 182, 'Dog and Cat Food Manufacturing': 183, 'Dried and Dehydrated Food Manufacturing': 184, 'Drilling Oil and Gas Wells': 185, 'Drinking Places (Alcoholic Beverages)': 186, "Drugs and Druggists' Sundries Merchant Wholesalers": 187, 'Dry, Condensed, and Evaporated Dairy Product Manufacturing': 188, 'Drycleaning and Laundry Services (except Coin-Operated)': 189, 'Electric Bulk Power Transmission and Control': 190, 'Electric Housewares and Household Fan Manufacturing': 191, 'Electric Lamp Bulb and Part Manufacturing': 192, 'Electric Power Distribution': 193, 'Electric Power Generation, Transmission and Distribution': 194, 'Electric Power Transmission, Control, and Distribution': 195, 'Electrical Apparatus and Equipment, Wiring Supplies, and Related Equipment Merchant Wholesalers': 196, 'Electrical Contractors and Other Wiring Installation Contractors': 197, 'Electrical Equipment, Appliance, and Component Manufacturing': 198, 'Electromedical and Electrotherapeutic Apparatus Manufacturing': 199, 'Electronic Capacitor Manufacturing': 200, 'Electronic Connector Manufacturing': 201, 'Electronic Shopping and Mail-Order Houses': 202, 'Electroplating, Plating, Polishing, Anodizing, and Coloring': 203, 'Elementary and Secondary Schools': 204, 'Elevator and Moving Stairway Manufacturing': 205, 'Emergency and Other Relief Services': 206, 'Employment Placement Agencies': 207, 'Employment Placement Agencies and Executive Search Services': 208, 'Engineered Wood Member (except Truss) Manufacturing': 209, 'Engineering Services': 210, 'Envelope Manufacturing': 211, 'Environmental Consulting Services': 212, 'Ethyl Alcohol Manufacturing': 213, 'Executive Offices': 214, 'Executive and Legislative Offices, Combined': 215, 'Explosives Manufacturing': 216, 'Exterminating and Pest Control Services': 217, 'Fabric Coating Mills': 218, 'Fabricated Pipe and Pipe Fitting Manufacturing': 219, 'Fabricated Structural Metal Manufacturing': 220, 'Facilities Support Services': 221, 'Farm Machinery and Equipment Manufacturing': 222, 'Farm Product Warehousing and Storage': 223, 'Farm Supplies Merchant Wholesalers': 224, 'Fastener, Button, Needle, and Pin Manufacturing': 225, 'Fats and Oils Refining and Blending': 226, 'Fertilizer (Mixing Only) Manufacturing': 227, 'Fiber Can, Tube, Drum, and Similar Products Manufacturing': 228, 'Fiber Optic Cable Manufacturing': 229, 'Finfish Farming and Fish Hatcheries': 230, 'Finfish Fishing': 231, 'Finish Carpentry Contractors': 232, 'Fire Protection': 233, 'Fish and Seafood Markets': 234, 'Fish and Seafood Merchant Wholesalers': 235, 'Fitness and Recreational Sports Centers': 236, 'Flat Glass Manufacturing': 237, 'Flavoring Syrup and Concentrate Manufacturing': 238, 'Floor Covering Stores': 239, 'Flooring Contractors': 240, 'Floriculture Production': 241, 'Florists': 242, 'Flour Milling': 243, 'Flour Mixes and Dough Manufacturing from Purchased Flour': 244, "Flower, Nursery Stock, and Florists' Supplies Merchant Wholesalers": 245, 'Fluid Milk Manufacturing': 246, 'Fluid Power Cylinder and Actuator Manufacturing': 247, 'Fluid Power Pump and Motor Manufacturing': 248, 'Fluid Power Valve and Hose Fitting Manufacturing': 249, 'Folding Paperboard Box Manufacturing': 250, 'Food Product Machinery Manufacturing': 251, 'Forest Nurseries and Gathering of Forest Products': 252, 'Fossil Fuel Electric Power Generation': 253, 'Framing Contractors': 254, 'Freight Transportation Arrangement': 255, 'Fresh Fruit and Vegetable Merchant Wholesalers': 256, 'Fresh and Frozen Seafood Processing': 257, 'Frozen Cakes, Pies, and Other Pastries Manufacturing': 258, 'Frozen Fruit, Juice, and Vegetable Manufacturing': 259, 'Frozen Specialty Food Manufacturing': 260, 'Fruit and Vegetable Canning': 261, 'Fruit and Vegetable Markets': 262, 'Full-Service Restaurants': 263, 'Funeral Homes and Funeral Services': 264, 'Furniture Merchant Wholesalers': 265, 'Furniture Stores': 266, "Game, Toy, and Children's Vehicle Manufacturing": 267, 'Gasket, Packing, and Sealing Device Manufacturing': 268, 'Gasoline Engine and Engine Parts Manufacturing': 269, 'General Automotive Repair': 270, 'General Freight Trucking, Local': 271, 'General Freight Trucking, Long-Distance, Truckload': 272, 'General Line Grocery Merchant Wholesalers': 273, 'General Medical and Surgical Hospitals': 274, 'General Warehousing and Storage': 275, 'Gift, Novelty, and Souvenir Stores': 276, 'Glass Container Manufacturing': 277, 'Glass Product Manufacturing Made of Purchased Glass': 278, 'Gold Ore Mining': 279, 'Golf Courses and Country Clubs': 280, 'Grain and Field Bean Merchant Wholesalers': 281, 'Graphic Design Services': 282, 'Ground or Treated Mineral and Earth Manufacturing': 283, 'Guided Missile and Space Vehicle Manufacturing': 284, 'Guided Missile and Space Vehicle Propulsion Unit and Propulsion Unit Parts Manufacturing': 285, 'Gypsum Product Manufacturing': 286, 'HMO Medical Centers': 287, 'Hand and Edge Tool Manufacturing': 288, 'Hardware Manufacturing': 289, 'Hardware Merchant Wholesalers': 290, 'Hardware Stores': 291, 'Hardwood Veneer and Plywood Manufacturing': 292, 'Hat, Cap, and Millinery Manufacturing': 293, 'Hazardous Waste Treatment and Disposal': 294, 'Heating Equipment (except Warm Air Furnaces) Manufacturing': 295, 'Heavy Duty Truck Manufacturing': 296, 'Highway, Street, and Bridge Construction': 297, 'Hobby, Toy, and Game Stores': 298, 'Hog and Pig Farming': 299, 'Home Centers': 300, 'Home Furnishing Merchant Wholesalers': 301, 'Hotels (except Casino Hotels) and Motels': 302, 'Household Appliance Stores': 303, 'Household Cooking Appliance Manufacturing': 304, 'Household Furniture (except Wood and Metal) Manufacturing': 305, 'Household Laundry Equipment Manufacturing': 306, 'Household Refrigerator and Home Freezer Manufacturing': 307, 'Household and Institutional Furniture and Kitchen Cabinet Manufacturing': 308, 'Human Resources Consulting Services': 309, 'Hunting and Trapping': 310, 'Ice Cream and Frozen Dessert Manufacturing': 311, 'Ice Manufacturing': 312, 'Independent Artists, Writers, and Performers': 313, 'Industrial Building Construction': 314, 'Industrial Gas Manufacturing': 315, 'Industrial Launderers': 316, 'Industrial Machinery and Equipment Merchant Wholesalers': 317, 'Industrial Mold Manufacturing': 318, 'Industrial Pattern Manufacturing': 319, 'Industrial Process Furnace and Oven Manufacturing': 320, 'Industrial Sand Mining': 321, 'Industrial Supplies Merchant Wholesalers': 322, 'Industrial Truck, Tractor, Trailer, and Stacker Machinery Manufacturing': 323, 'Industrial Valve Manufacturing': 324, 'Industrial and Commercial Fan and Blower Manufacturing': 325, 'Industrial and Personal Service Paper Merchant Wholesalers': 326, 'Information': 327, 'Inorganic Dye and Pigment Manufacturing': 328, 'Institutional Furniture Manufacturing': 329, 'Instrument Manufacturing for Measuring and Testing Electricity and Electrical Signals': 330, 'Instruments and Related Products Manufacturing for Measuring, Displaying, and Controlling Industrial Process Variables': 331, 'Insurance Agencies and Brokerages': 332, 'Iron Foundries': 333, 'Iron Ore Mining': 334, 'Iron and Steel Forging': 335, 'Iron and Steel Mills': 336, 'Iron and Steel Pipe and Tube Manufacturing from Purchased Steel': 337, 'Janitorial Services': 338, 'Jewelry (except Costume) Manufacturing': 339, 'Junior Colleges': 340, 'Labor Unions and Similar Labor Organizations': 341, 'Laminated Plastics Plate, Sheet (except Packaging), and Shape Manufacturing': 342, 'Land Subdivision': 343, 'Landscape Architectural Services': 344, 'Landscaping Services': 345, 'Lawn and Garden Tractor and Home Lawn and Garden Equipment Manufacturing': 346, 'Leather and Hide Tanning and Finishing': 347, 'Legislative Bodies': 348, 'Lessors of Nonresidential Buildings (except Miniwarehouses)': 349, 'Light Truck and Utility Vehicle Manufacturing': 350, 'Lime Manufacturing': 351, 'Limited-Service Restaurants': 352, 'Line-Haul Railroads': 353, 'Linen Supply': 354, 'Local Messengers and Local Delivery': 355, 'Logging': 356, 'Lumber, Plywood, Millwork, and Wood Panel Merchant Wholesalers': 357, 'Machine Shops': 358, 'Machine Tool (Metal Cutting Types) Manufacturing': 359, 'Machine Tool (Metal Forming Types) Manufacturing': 360, 'Magnetic and Optical Recording Media Manufacturing': 361, 'Mail-Order Houses': 362, 'Malt Manufacturing': 363, 'Manifold Business Forms Printing': 364, 'Manufactured (Mobile) Home Dealers': 365, 'Manufactured Home (Mobile Home) Manufacturing': 366, 'Marinas': 367, 'Marine Cargo Handling': 368, 'Marketing Consulting Services': 369, 'Marketing Research and Public Opinion Polling': 370, 'Marking Device Manufacturing': 371, 'Masonry Contractors': 372, 'Materials Recovery Facilities': 373, 'Mattress Manufacturing': 374, 'Mayonnaise, Dressing, and Other Prepared Sauce Manufacturing': 375, 'Meat Processed from Carcasses': 376, 'Meat and Meat Product Merchant Wholesalers': 377, 'Mechanical Power Transmission Equipment Manufacturing': 378, 'Media Representatives': 379, 'Medical Laboratories': 380, 'Medical, Dental, and Hospital Equipment and Supplies Merchant Wholesalers': 381, "Men's Clothing Stores": 382, "Men's Footwear (except Athletic) Manufacturing": 383, "Men's and Boys' Cut and Sew Work Clothing Manufacturing": 384, 'Metal Can Manufacturing': 385, 'Metal Coating, Engraving (except Jewelry and Silverware), and Allied Services to Manufacturers': 386, 'Metal Heat Treating': 387, 'Metal Household Furniture Manufacturing': 388, 'Metal Service Centers and Other Metal Merchant Wholesalers': 389, 'Metal Stamping': 390, 'Metal Tank (Heavy Gauge) Manufacturing': 391, 'Metal Window and Door Manufacturing': 392, 'Military Armored Vehicle, Tank, and Tank Component Manufacturing': 393, 'Mining Machinery and Equipment Manufacturing': 394, 'Mixed Mode Transit Systems': 395, 'Motion Picture and Video Production': 396, 'Motor Home Manufacturing': 397, 'Motor Vehicle Body Manufacturing': 398, 'Motor Vehicle Brake System Manufacturing': 399, 'Motor Vehicle Metal Stamping': 400, 'Motor Vehicle Parts (Used) Merchant Wholesalers': 401, 'Motor Vehicle Seating and Interior Trim Manufacturing': 402, 'Motor Vehicle Steering and Suspension Components (except Spring) Manufacturing': 403, 'Motor Vehicle Supplies and New Parts Merchant Wholesalers': 404, 'Motor Vehicle Towing': 405, 'Motor Vehicle Transmission and Power Train Parts Manufacturing': 406, 'Motor and Generator Manufacturing': 407, 'Motorcycle, ATV, and Personal Watercraft Dealers': 408, 'Motorcycle, Bicycle, and Parts Manufacturing': 409, 'Museums': 410, 'Musical Groups and Artists': 411, 'Musical Instrument Manufacturing': 412, 'Narrow Fabric Mills': 413, 'National Security': 414, 'Natural Gas Distribution': 415, 'Natural Gas Liquid Extraction': 416, 'Nature Parks and Other Similar Institutions': 417, 'Navigational Services to Shipping': 418, 'New Car Dealers': 419, 'New Single-Family Housing Construction (except Operative Builders)': 420, 'News Dealers and Newsstands': 421, 'Newspaper Publishers': 422, 'Newsprint Mills': 423, 'Nitrogenous Fertilizer Manufacturing': 424, 'Nonchocolate Confectionery Manufacturing': 425, 'Nonclay Refractory Manufacturing': 426, 'Noncurrent-Carrying Wiring Device Manufacturing': 427, 'Nonferrous (except Aluminum) Die-Casting Foundries': 428, 'Nonferrous Forging': 429, 'Nonferrous Metal (except Copper and Aluminum) Rolling, Drawing, and Extruding': 430, 'Nonfolding Sanitary Food Container Manufacturing': 431, 'Nonresidential Property Managers': 432, 'Nonscheduled Chartered Freight Air Transportation': 433, 'Nonscheduled Chartered Passenger Air Transportation': 434, 'Nonupholstered Wood Household Furniture Manufacturing': 435, 'Nursery, Garden Center, and Farm Supply Stores': 436, 'Nursing Care Facilities': 437, 'Office Administrative Services': 438, 'Office Furniture (except Wood) Manufacturing': 439, 'Office Machinery Manufacturing': 440, 'Offices of All Other Miscellaneous Health Practitioners': 441, 'Offices of Chiropractors': 442, 'Offices of Lawyers': 443, 'Offices of Other Holding Companies': 444, 'Offices of Physicians (except Mental Health Specialists)': 445, 'Offices of Real Estate Agents and Brokers': 446, 'Oil and Gas Pipeline and Related Structures Construction': 447, 'Open-End Investment Funds': 448, 'Ornamental and Architectural Metal Work Manufacturing': 449, 'Other Activities Related to Real Estate': 450, 'Other Aircraft Parts and Auxiliary Equipment Manufacturing': 451, 'Other Airport Operations': 452, 'Other Aluminum Rolling and Drawing': 453, 'Other Animal Food Manufacturing': 454, 'Other Automotive Mechanical and Electrical Repair and Maintenance': 455, 'Other Building Equipment Contractors': 456, 'Other Building Finishing Contractors': 457, 'Other Building Material Dealers': 458, 'Other Business Service Centers (including Copy Shops)': 459, 'Other Chemical and Allied Products Merchant Wholesalers': 460, 'Other Clothing Stores': 461, 'Other Commercial Printing': 462, 'Other Commercial and Industrial Machinery and Equipment Rental and Leasing': 463, 'Other Commercial and Service Industry Machinery Manufacturing': 464, 'Other Communication and Energy Wire Manufacturing': 465, 'Other Communications Equipment Manufacturing': 466, 'Other Computer Peripheral Equipment Manufacturing': 467, 'Other Concrete Product Manufacturing': 468, 'Other Construction Material Merchant Wholesalers': 469, 'Other Crushed and Broken Stone Mining and Quarrying': 470, 'Other Direct Selling Establishments': 471, 'Other Electric Power Generation': 472, 'Other Electronic Component Manufacturing': 473, 'Other Electronic Parts and Equipment Merchant Wholesalers': 474, 'Other Electronic and Precision Equipment Repair and Maintenance': 475, 'Other Engine Equipment Manufacturing': 476, 'Other Fabricated Wire Product Manufacturing': 477, 'Other Farm Product Raw Material Merchant Wholesalers': 478, 'Other Foundation, Structure, and Building Exterior Contractors': 479, 'Other Fuel Dealers': 480, 'Other Gasoline Stations': 481, 'Other General Government Support': 482, 'Other Grocery and Related Products Merchant Wholesalers': 483, 'Other Heavy and Civil Engineering Construction': 484, 'Other Hosiery and Sock Mills': 485, 'Other Household Textile Product Mills': 486, 'Other Individual and Family Services': 487, 'Other Justice, Public Order, and Safety Activities': 488, 'Other Lighting Equipment Manufacturing': 489, 'Other Management Consulting Services': 490, 'Other Measuring and Controlling Device Manufacturing': 491, 'Other Metal Container Manufacturing': 492, 'Other Metal Valve and Pipe Fitting Manufacturing': 493, 'Other Metalworking Machinery Manufacturing': 494, 'Other Millwork (including Flooring)': 495, 'Other Miscellaneous Durable Goods Merchant Wholesalers': 496, 'Other Miscellaneous Nondurable Goods Merchant Wholesalers': 497, 'Other Motor Vehicle Electrical and Electronic Equipment Manufacturing': 498, 'Other Nonferrous Foundries (except Die-Casting)': 499, 'Other Nonhazardous Waste Treatment and Disposal': 500, 'Other Nonscheduled Air Transportation': 501, 'Other Ordnance and Accessories Manufacturing': 502, 'Other Personal and Household Goods Repair and Maintenance': 503, 'Other Poultry Production': 504, 'Other Pressed and Blown Glass and Glassware Manufacturing': 505, 'Other Professional Equipment and Supplies Merchant Wholesalers': 506, 'Other Scientific and Technical Consulting Services': 507, 'Other Services Related to Advertising': 508, 'Other Services to Buildings and Dwellings': 509, 'Other Similar Organizations (except Business, Professional, Labor, and Political Organizations)': 510, 'Other Snack Food Manufacturing': 511, 'Other Social Advocacy Organizations': 512, 'Other Specialized Design Services': 513, 'Other Support Activities for Air Transportation': 514, 'Other Support Activities for Road Transportation': 515, 'Other Vegetable (except Potato) and Melon Farming': 516, 'Other Warehousing and Storage': 517, 'Other Waste Collection': 518, 'Outdoor Power Equipment Stores': 519, 'Outerwear Knitting Mills': 520, 'Overhead Traveling Crane, Hoist, and Monorail System Manufacturing': 521, 'Packaged Frozen Food Merchant Wholesalers': 522, 'Packaging Machinery Manufacturing': 523, 'Packaging and Labeling Services': 524, 'Packing and Crating': 525, 'Paint and Coating Manufacturing': 526, 'Paint and Wallpaper Stores': 527, 'Paint, Varnish, and Supplies Merchant Wholesalers': 528, 'Painting and Wall Covering Contractors': 529, 'Paper (except Newsprint) Mills': 530, 'Paperboard Mills': 531, 'Parking Lots and Garages': 532, 'Periodical Publishers': 533, 'Pesticide and Other Agricultural Chemical Manufacturing': 534, 'Pet Care (except Veterinary) Services': 535, 'Petrochemical Manufacturing': 536, 'Petroleum Lubricating Oil and Grease Manufacturing': 537, 'Petroleum Refineries': 538, 'Pharmaceutical Preparation Manufacturing': 539, 'Pharmacies and Drug Stores': 540, 'Photofinishing Laboratories (except One-Hour)': 541, 'Photographic and Photocopying Equipment Manufacturing': 542, 'Pipeline Transportation of Natural Gas': 543, 'Plastics Bag and Pouch Manufacturing': 544, 'Plastics Bottle Manufacturing': 545, 'Plastics Material and Resin Manufacturing': 546, 'Plastics Materials and Basic Forms and Shapes Merchant Wholesalers': 547, 'Plastics Packaging Film and Sheet (including Laminated) Manufacturing': 548, 'Plastics Packaging Materials and Unlaminated Film and Sheet Manufacturing': 549, 'Plastics Pipe and Pipe Fitting Manufacturing': 550, 'Plastics Plumbing Fixture Manufacturing': 551, 'Plastics and Rubber Industry Machinery Manufacturing': 552, 'Plate Work Manufacturing': 553, 'Plumbing Fixture Fitting and Trim Manufacturing': 554, 'Plumbing and Heating Equipment and Supplies (Hydronics) Merchant Wholesalers': 555, 'Plumbing, Heating, and Air-Conditioning Contractors': 556, 'Police Protection': 557, 'Polish and Other Sanitation Good Manufacturing': 558, 'Polystyrene Foam Product Manufacturing': 559, 'Porcelain Electrical Supply Manufacturing': 560, 'Port and Harbor Operations': 561, 'Postal Service': 562, 'Postharvest Crop Activities (except Cotton Ginning)': 563, 'Poultry Hatcheries': 564, 'Poultry Processing': 565, 'Poultry and Poultry Product Merchant Wholesalers': 566, 'Poured Concrete Foundation and Structure Contractors': 567, 'Power Boiler and Heat Exchanger Manufacturing': 568, 'Power and Communication Line and Related Structures Construction': 569, 'Power, Distribution, and Specialty Transformer Manufacturing': 570, 'Precision Turned Product Manufacturing': 571, 'Prefabricated Metal Building and Component Manufacturing': 572, 'Prefabricated Wood Building Manufacturing': 573, 'Prepress Services': 574, 'Prerecorded Compact Disc (except Software), Tape, and Record Reproducing': 575, 'Prerecorded Tape, Compact Disc, and Record Stores': 576, 'Primary Aluminum Production': 577, 'Primary Smelting and Refining of Copper': 578, 'Primary Smelting and Refining of Nonferrous Metal (except Copper and Aluminum)': 579, 'Printed Circuit Assembly (Electronic Assembly) Manufacturing': 580, 'Printing': 581, 'Printing Ink Manufacturing': 582, 'Printing Machinery and Equipment Manufacturing': 583, 'Professional, Scientific, and Technical Services': 584, 'Promoters of Performing Arts, Sports, and Similar Events without Facilities': 585, 'Public Finance Activities': 586, 'Publishing Industries (except Internet)': 587, 'Pulp Mills': 588, 'Pulp, Paper, and Paperboard Mills': 589, 'Pump and Pumping Equipment Manufacturing': 590, 'Quick Printing': 591, 'Racetracks': 592, 'Radio and Television Broadcasting and Wireless Communications Equipment Manufacturing': 593, 'Radio, Television, and Other Electronics Stores': 594, 'Ready-Mix Concrete Manufacturing': 595, 'Reconstituted Wood Product Manufacturing': 596, 'Recyclable Material Merchant Wholesalers': 597, 'Refrigerated Warehousing and Storage': 598, 'Regulation and Administration of Transportation Programs': 599, 'Regulation, Licensing, and Inspection of Miscellaneous Commercial Sectors': 600, 'Relay and Industrial Control Manufacturing': 601, 'Religious Organizations': 602, 'Remediation Services': 603, 'Rendering and Meat Byproduct Processing': 604, 'Research and Development in Biotechnology': 605, 'Research and Development in the Physical, Engineering, and Life Sciences (except Biotechnology)': 606, 'Research and Development in the Social Sciences and Humanities': 607, 'Residential Mental Retardation Facilities': 608, 'Residential Remodelers': 609, 'Retail Bakeries': 610, 'Reupholstery and Furniture Repair': 611, 'Roasted Nuts and Peanut Butter Manufacturing': 612, 'Rolled Steel Shape Manufacturing': 613, 'Roofing Contractors': 614, 'Roofing, Siding, and Insulation Material Merchant Wholesalers': 615, 'Rope, Cordage, and Twine Mills': 616, 'Rubber Product Manufacturing for Mechanical Use': 617, 'Rubber and Plastics Hoses and Belting Manufacturing': 618, 'Sanitary Paper Product Manufacturing': 619, 'Sawmill and Woodworking Machinery Manufacturing': 620, 'Sawmills': 621, 'Sawmills and Wood Preservaton': 622, 'Scale and Balance Manufacturing': 623, 'Scenic and Sightseeing Transportation, Land': 624, 'Scenic and Sightseeing Transportation, Water': 625, 'Scheduled Freight Air Transportation': 626, 'Scheduled Passenger Air Transportation': 627, 'School and Employee Bus Transportation': 628, 'Seafood Canning': 629, 'Search, Detection, Navigation, Guidance, Aeronautical, and Nautical System and Instrument Manufacturing': 630, 'Secondary Smelting and Alloying of Aluminum': 631, 'Secondary Smelting, Refining, and Alloying of Copper': 632, 'Secondary Smelting, Refining, and Alloying of Nonferrous Metal (except Copper and Aluminum)': 633, 'Security Guards and Patrol Services': 634, 'Semiconductor and Other Electronic Component Manufacturing': 635, 'Service Establishment Equipment and Supplies Merchant Wholesalers': 636, 'Setup Paperboard Box Manufacturing': 637, 'Sewage Treatment Facilities': 638, 'Sheet Metal Work Manufacturing': 639, 'Ship Building and Repairing': 640, 'Showcase, Partition, Shelving, and Locker Manufacturing': 641, 'Sign Manufacturing': 642, 'Site Preparation Contractors': 643, 'Skiing Facilities': 644, 'Small Arms Manufacturing': 645, 'Snack and Nonalcoholic Beverage Bars': 646, 'Soap and Other Detergent Manufacturing': 647, 'Soft Drink Manufacturing': 648, 'Soft Drink and Ice Manufacturing': 649, 'Software Publishers': 650, 'Softwood Veneer and Plywood Manufacturing': 651, 'Solid Waste Collection': 652, 'Solid Waste Combustors and Incinerators': 653, 'Solid Waste Landfill': 654, 'Soybean Processing': 655, 'Special Die and Tool, Die Set, Jig, and Fixture Manufacturing': 656, 'Specialized Freight (except Used Goods) Trucking, Long-Distance': 657, 'Specialty (except Psychiatric and Substance Abuse) Hospitals': 658, 'Specialty Canning': 659, 'Speed Changer, Industrial High-Speed Drive, and Gear Manufacturing': 660, 'Spice and Extract Manufacturing': 661, 'Sporting Goods Stores': 662, 'Sporting and Athletic Goods Manufacturing': 663, 'Sports and Recreation Instruction': 664, 'Spring (Heavy Gauge) Manufacturing': 665, 'Spring (Light Gauge) Manufacturing': 666, 'Starch and Vegetable Fats and Oils Manufacturing': 667, 'Stationery and Office Supplies Merchant Wholesalers': 668, 'Stationery, Tablet, and Related Product Manufacturing': 669, 'Steel Foundries (except Investment)': 670, 'Steel Investment Foundries': 671, 'Storage Battery Manufacturing': 672, 'Structural Steel and Precast Concrete Contractors': 673, 'Supermarkets and Other Grocery (except Convenience) Stores': 674, 'Support Activities for Forestry': 675, 'Support Activities for Nonmetallic Minerals (except Fuels) Mining': 676, 'Support Activities for Oil and Gas Operations': 677, 'Support Activities for Rail Transportation': 678, 'Surface-Coated Paperboard Manufacturing': 679, 'Surgical Appliance and Supplies Manufacturing': 680, 'Surgical and Medical Instrument Manufacturing': 681, 'Surveying and Mapping (except Geophysical) Services': 682, 'Switchgear and Switchboard Apparatus Manufacturing': 683, 'Synthetic Organic Dye and Pigment Manufacturing': 684, 'Telecommunications Resellers': 685, 'Telephone Apparatus Manufacturing': 686, 'Temporary Help Services': 687, 'Testing Laboratories': 688, 'Textile Bag Mills': 689, 'Textile and Fabric Finishing and Fabric Coating Mills': 690, 'Tile and Terrazzo Contractors': 691, 'Timber Tract Operations': 692, 'Tire Dealers': 693, 'Tire Manufacturing (except Retreading)': 694, 'Tire and Tube Merchant Wholesalers': 695, 'Toilet Preparation Manufacturing': 696, 'Totalizing Fluid Meter and Counting Device Manufacturing': 697, 'Toy and Hobby Goods and Supplies Merchant Wholesalers': 698, 'Tradebinding and Related Work': 699, 'Travel Trailer and Camper Manufacturing': 700, 'Truck Trailer Manufacturing': 701, 'Truck, Utility Trailer, and RV (Recreational Vehicle) Rental and Leasing': 702, 'Truss Manufacturing': 703, 'Turbine and Turbine Generator Set Units Manufacturing': 704, 'Turkey Production': 705, 'Unlaminated Plastics Film and Sheet (except Packaging) Manufacturing': 706, 'Unlaminated Plastics Profile Shape Manufacturing': 707, 'Upholstered Household Furniture Manufacturing': 708, 'Urethane and Other Foam Product (except Polystyrene) Manufacturing': 709, 'Used Household and Office Goods Moving': 710, 'Utilities': 711, 'Vehicular Lighting Equipment Manufacturing': 712, 'Veterinary Services': 713, 'Video Tape and Disc Rental': 714, 'Vitreous China Plumbing Fixture and China and Earthenware Bathroom Accessories Manufacturing': 715, 'Vocational Rehabilitation Services': 716, 'Warm Air Heating and Air-Conditioning Equipment and Supplies Merchant Wholesalers': 717, 'Waste Treatment and Disposal': 718, 'Watch, Clock, and Part Manufacturing': 719, 'Water Supply and Irrigation Systems': 720, 'Water and Sewer Line and Related Structures Construction': 721, 'Water, Sewage and Other Systems': 722, 'Welding and Soldering Equipment Manufacturing': 723, 'Wet Corn Milling': 724, 'Wholesale Trade': 725, 'Wholesale Trade Agents and Brokers': 726, 'Wineries': 727, "Women's Clothing Stores": 728, 'Wood Container and Pallet Manufacturing': 729, 'Wood Kitchen Cabinet and Countertop Manufacturing': 730, 'Wood Office Furniture Manufacturing': 731, 'Wood Preservation': 732, 'Wood Television, Radio, and Sewing Machine Cabinet Manufacturing': 733, 'Wood Window and Door Manufacturing': 734, 'Yarn Spinning Mills': 735}
        
        leftModel = load_model('../models/LeftModel')
        rightModel = load_model('../models/RightModel')
        scalerRight, scalerYRight = load('../models/model_with_scaler.pkl')
        scalerLeft, scalerYLeft = load('../models/model_with_scalerLeft.pkl')
        
        
        
        def generateAudiogram (ageGroupUser, genderUser, industryUser, militaryStatus, q1, q2, q3, df):
            L500 = np.array(df['L500'])
            L1k = np.array(df['L1k'])
            L2k = np.array(df['L2k'])
            L3k = np.array(df['L3k'])
            L4k = np.array(df['L4k'])
            L6k = np.array(df['L6k'])
            L8k = np.array(df['L8k'])
            R500 = np.array(df['R500'])
            R1k = np.array(df['R1k'])
            R3k = np.array(df['R3k'])
            R2k = np.array(df['R2k'])
            R4k = np.array(df['R4k'])
            R6k = np.array(df['R6k'])
            R8k = np.array(df['R8k'])
            gender = np.array(df['Gender'])
            ageGroup = np.array(df['AgeGroup'])
            industry = np.array(df['Industry'])
            if industryUser in industryMapping:
                industryUser = industryMapping[industryUser]
            data_specific = df[(df['Industry'] == industryUser) & (df['AgeGroup'] == ageGroupUser) & (df['Gender'] == genderUser)]
        
            frequency_columns = ['L8k', 'L6k', 'L4k', 'L3k', 'L2k', 'L1k', 'L500', 'R500', 'R1k', 'R2k', 'R3k', 'R4k', 'R6k', 'R8k']
            hearing_avg = data_specific[frequency_columns].mean().reset_index()
        
            L2k = hearing_avg.loc[hearing_avg['index'] == 'L2k'].values[0][1]
            L4k = hearing_avg.loc[hearing_avg['index'] == 'L4k'].values[0][1]
            R2k = hearing_avg.loc[hearing_avg['index'] == 'R2k'].values[0][1]
            R4k = hearing_avg.loc[hearing_avg['index'] == 'R4k'].values[0][1]
        
            new_data = np.array([L2k, L4k, q1, q2, q3, genderUser, ageGroupUser, militaryStatus])
            new_data_scaled = scalerLeft.transform(new_data.reshape(1, -1))  # Reshaping to 2D array
            predictions = leftModel.predict(new_data_scaled)
            predictions = scalerYLeft.inverse_transform(predictions)
            L500, L1000, L3000, L6000, L8000 = predictions.flatten()
            values = {
                "500": L500,
                "1K": L1000,
                "2K": L2k,
                "3K": L3000,
                "4K": L4k,
                "6K": L6000,
                "8K": L8000,
            }
            frequencies = list(values.keys())
            db_levels = list(values.values())
            plt.figure(figsize=(15, 8))
            plt.plot(frequencies, db_levels, marker='o', color='red', label='Left')
            plt.title('DNN 2k and 4k')
            plt.xlabel('Frequency')
            plt.ylabel('Average dB Level')
            plt.grid(True)
            plt.ylim(100, 0)
        
            new_data = np.array([R2k, R4k, q1, q2, q3, genderUser, ageGroupUser, militaryStatus])
            new_data_scaled = scalerRight.transform(new_data.reshape(1, -1))  # Reshaping to 2D array
            predictions = rightModel.predict(new_data_scaled)
            predictions = scalerYRight.inverse_transform(predictions)
            R500, R1000, R3000, R6000, R8000 = predictions.flatten()
            values = {
                "500": R500,
                "1K": R1000,
                "2K": R2k,
                "3K": R3000,
                "4K": R4k,
                "6K": R6000,
                "8K": R8000,
            }
            frequencies = list(values.keys())
            db_levels = list(values.values())
            plt.plot(frequencies, db_levels, marker='o', color='blue', label='Right')
            plt.title('Personalized Audiogram')
            plt.xlabel('Frequency')
            plt.ylabel('Average dB Level')
            plt.ylim(100, 0)
            plt.grid()
            plt.legend()
            buf = BytesIO()
            plt.savefig(buf, format='png')
            buf.seek(0)
            img_base64 = base64.b64encode(buf.read()).decode('utf-8')
            img_url = f"data:image/png;base64,{img_base64}"
        
            return img_url  # Return a data URL for the generated image
        
        generateAudiogram(4, 1, 'Administration of Human Resource Programs (except Education, Public Health, and Veterans' Affairs Programs)', 2, 5, 1, 1, df)

